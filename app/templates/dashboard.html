{% extends "base.html" %}

{% block title %}Dashboard - Savannah Jobs{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>New Jobs</h2>
    <div>
        <button class="btn btn-outline-warning me-2" onclick="showSavedJobs()">‚≠ê View Saved</button>
        <button class="btn btn-outline-secondary me-2" onclick="showAllJobs()">Show All</button>
        <button class="btn btn-success me-2" onclick="fetchNewJobs()">Pull New Jobs</button>
        <button class="btn btn-primary" onclick="fetchJobs()">Refresh Display</button>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4">
        <input type="date" class="form-control" id="dateFilter" onchange="filterJobs()">
    </div>
    <div class="col-md-4">
        <input type="text" class="form-control" placeholder="Search jobs..." id="searchFilter" onkeyup="filterJobs()">
    </div>
    <div class="col-md-4">
        <select class="form-control" id="starredFilter" onchange="filterJobs()">
            <option value="unstarred">New Jobs (Default)</option>
            <option value="starred">‚≠ê Saved Jobs</option>
            <option value="">Show All Jobs</option>
        </select>
    </div>
</div>

<div id="jobsContainer">
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading jobs...</p>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

let authToken = getCookie('access_token')?.replace('Bearer ', '');
let allJobs = [];

async function fetchJobs() {
    try {
        console.log('Fetching jobs with token:', authToken ? 'Token present' : 'No token');
        const response = await fetch('/api/jobs', {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch jobs');
        }
        
        allJobs = await response.json();
        displayJobs(allJobs);
    } catch (error) {
        console.error('Error fetching jobs:', error);
        let errorMessage = error.message;
        
        if (error.message.includes('Failed to fetch')) {
            if (!authToken) {
                errorMessage = 'Authentication required. Please refresh the page and log in again.';
            } else {
                errorMessage = 'Unable to connect to the server. Please check your connection and try again.';
            }
        }
        
        document.getElementById('jobsContainer').innerHTML = 
            `<div class="alert alert-danger">
                <h4>Error loading jobs</h4>
                <p>${errorMessage}</p>
                <button class="btn btn-primary" onclick="fetchJobs()">Try Again</button>
            </div>`;
    }
}

async function fetchNewJobs() {
    const button = document.querySelector('button[onclick="fetchNewJobs()"]');
    const originalText = button.textContent;
    
    try {
        button.textContent = 'Pulling Jobs...';
        button.disabled = true;
        
        const response = await fetch('/api/fetch-jobs', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch new jobs from API');
        }
        
        const result = await response.json();
        
        // Show success message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
            ${result.message || 'Successfully pulled new jobs!'}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('h2').parentNode);
        
        // Refresh the job list after a short delay
        setTimeout(() => {
            fetchJobs();
        }, 2000);
        
    } catch (error) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            Error pulling new jobs: ${error.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('h2').parentNode);
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
}

function displayJobs(jobs) {
    const container = document.getElementById('jobsContainer');
    
    if (jobs.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <h4>No jobs found!</h4>
                <p>Get started by clicking the <strong>"Pull New Jobs"</strong> button above to fetch the latest job postings from TheirStack API.</p>
                <p>Make sure you have set the <code>THEIRSTACK_API_KEY</code> environment variable.</p>
            </div>
        `;
        return;
    }
    
    const jobsHtml = jobs.map(jobResult => {
        const job = jobResult.job;
        const starIcon = jobResult.starred ? '‚òÖ' : '‚òÜ';
        const starClass = jobResult.starred ? 'text-warning' : 'text-muted';
        
        return `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="card-title">${job.title}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${job.company || 'Unknown Company'}</h6>
                            <p class="card-text">
                                <small class="text-muted">
                                    üìç ${job.location || 'Location not specified'} | 
                                    üìÖ ${jobResult.day} |
                                    üîó <a href="${job.url}" target="_blank">View Job</a>
                                </small>
                            </p>
                        </div>
                        <div class="d-flex flex-column align-items-end">
                            <button class="btn btn-link ${starClass}" onclick="toggleStar(${job.id}, ${jobResult.starred})">
                                <span style="font-size: 1.5em;">${starIcon}</span>
                            </button>
                            <button class="btn btn-success btn-sm mt-1" onclick="markApplied(${job.id})">
                                ‚úÖ Applied
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = jobsHtml;
}

async function toggleStar(jobId, isStarred) {
    try {
        const endpoint = isStarred ? `/api/jobs/${jobId}/unstar` : `/api/jobs/${jobId}/star`;
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            fetchJobs(); // Refresh the jobs list
        }
    } catch (error) {
        console.error('Error toggling star:', error);
    }
}

async function markApplied(jobId) {
    if (!confirm('Mark this job as applied? This will remove it from your job lists and add it to your applied jobs archive.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/jobs/${jobId}/apply`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ‚úÖ Job marked as applied! <a href="/applied" class="alert-link">View your applied jobs</a>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('h2').parentNode);
            
            // Refresh the job list to remove the applied job
            fetchJobs();
        } else {
            throw new Error('Failed to mark job as applied');
        }
    } catch (error) {
        alert('Error marking job as applied: ' + error.message);
    }
}

function showSavedJobs() {
    document.getElementById('starredFilter').value = 'starred';
    document.querySelector('h2').textContent = 'Saved Jobs';
    filterJobs();
}

function showAllJobs() {
    document.getElementById('starredFilter').value = '';
    document.querySelector('h2').textContent = 'All Jobs';
    filterJobs();
}

function showNewJobs() {
    document.getElementById('starredFilter').value = 'unstarred';
    document.querySelector('h2').textContent = 'New Jobs';
    filterJobs();
}

function filterJobs() {
    const dateFilter = document.getElementById('dateFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    const starredFilter = document.getElementById('starredFilter').value;
    
    let filteredJobs = allJobs.filter(jobResult => {
        const job = jobResult.job;
        
        // Date filter
        if (dateFilter && jobResult.day !== dateFilter) {
            return false;
        }
        
        // Search filter
        if (searchFilter) {
            const searchText = `${job.title} ${job.company} ${job.location}`.toLowerCase();
            if (!searchText.includes(searchFilter)) {
                return false;
            }
        }
        
        // Starred filter
        if (starredFilter === 'starred' && !jobResult.starred) {
            return false;
        }
        if (starredFilter === 'unstarred' && jobResult.starred) {
            return false;
        }
        
        return true;
    });
    
    displayJobs(filteredJobs);
}

// Load jobs when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Check URL parameters for filtering
    const urlParams = new URLSearchParams(window.location.search);
    const filterParam = urlParams.get('filter');
    
    if (filterParam === 'starred') {
        document.getElementById('starredFilter').value = 'starred';
        document.querySelector('h2').textContent = 'Saved Jobs';
    } else if (filterParam === 'all') {
        document.getElementById('starredFilter').value = '';
        document.querySelector('h2').textContent = 'All Jobs';
    } else {
        // Default to showing unstarred (new) jobs
        document.getElementById('starredFilter').value = 'unstarred';
        document.querySelector('h2').textContent = 'New Jobs';
    }
    
    fetchJobs();
});
</script>
{% endblock %}